<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #4a69bd 0%, #3d5a9e 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .header h1 {
            margin-bottom: 10px;
        }
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        .nav-tab {
            flex: 1;
            padding: 15px;
            background-color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .nav-tab.active {
            background-color: #4a69bd;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .invoice-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-title {
            color: #4a69bd;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4a69bd;
        }
        .exchange-rate {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .exchange-rate input {
            width: 150px;
            padding: 8px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            border: 2px solid #4a69bd;
            border-radius: 4px;
        }
        .customer-section {
            margin-bottom: 25px;
        }
        .customer-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .customer-input:focus {
            border-color: #4a69bd;
            outline: none;
        }
        .service-input-section {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .input-group {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 100px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .input-group input, .input-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .add-btn {
            background-color: #4a69bd;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .add-btn:hover {
            background-color: #3d5a9e;
        }
        .selected-services {
            margin-top: 20px;
            border-top: 2px solid #ddd;
            padding-top: 20px;
        }
        .service-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        .service-row:hover {
            background-color: #f9f9f9;
        }
        .remove-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .total-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #e8f4f8;
            border-radius: 5px;
            text-align: right;
        }
        .total-amount {
            font-size: 24px;
            font-weight: bold;
            color: #4a69bd;
        }
        .action-buttons {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .button {
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .whatsapp-button {
            background-color: #25d366;
        }
        .copy-button {
            background-color: #4a69bd;
        }
        .save-button {
            background-color: #28a745;
        }
        .notification {
            display: none;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
        .notification.success {
            background-color: #4CAF50;
            color: white;
        }
        .notification.error {
            background-color: #ff4444;
            color: white;
        }
        .error {
            color: #ff4444;
            font-size: 14px;
            margin-top: 5px;
        }
        .filters {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .filter-input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .stat-card .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #4a69bd;
        }
        .stat-card.paid {
            border-left: 5px solid #28a745;
        }
        .stat-card.unpaid {
            border-left: 5px solid #ff4444;
        }
        .stat-card.total {
            border-left: 5px solid #4a69bd;
        }
        .invoice-table {
            background-color: white;
            border-radius: 8px;
            overflow-x: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background-color: #4a69bd;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        .status-badge.paid {
            background-color: #d4edda;
            color: #155724;
        }
        .status-badge.not-paid {
            background-color: #f8d7da;
            color: #721c24;
        }
        .action-btn {
            padding: 5px 10px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .update-btn {
            background-color: #ffc107;
            color: #000;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        .quick-create-btn {
            background-color: #17a2b8;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        @media (max-width: 768px) {
            .input-group {
                grid-template-columns: 1fr;
            }
            .action-buttons {
                grid-template-columns: 1fr;
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Invoice Management System</h1>
            <p>Manage your invoices and track payments efficiently</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="create">
                üÜï Create Invoice
            </button>
            <button class="nav-tab" data-tab="list">
                üìã All Invoices
            </button>
        </div>

        <div id="create-tab" class="tab-content active">
            <div class="invoice-container">
                <h2 class="section-title">Create New Invoice</h2>

                <div class="exchange-rate">
                    <label><strong>Current USD Rate (LKR):</strong></label><br>
                    <input type="number" id="usdRate" value="300" min="1" step="0.01">
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Formula: (USD Rate + 180) x USD Amount
                    </p>
                </div>

                <div class="customer-section">
                    <label><strong>Customer Name (Required):</strong></label>
                    <input type="text" id="customerName" class="customer-input" placeholder="Enter customer name" required>
                    <div id="customerError" class="error"></div>
                </div>

                <div class="service-input-section">
                    <h3>Add Services:</h3>
                    <div class="input-group">
                        <input type="text" id="serviceName" placeholder="Service Name (e.g., Facebook Ads, SEO)" />
                        <select id="priceType">
                            <option value="custom">Custom Price</option>
                            <option value="usd">USD Based</option>
                        </select>
                        <input type="number" id="servicePrice" placeholder="Amount" min="0" step="0.01" />
                        <button class="add-btn" id="addServiceBtn">Add</button>
                    </div>
                    <p style="font-size: 12px; color: #666;">
                        üí° Tip: Type service name and amount, then click Add. Select "USD Based" for automatic conversion.
                    </p>
                </div>

                <div class="selected-services">
                    <h3>Selected Services:</h3>
                    <div id="selected-items">
                        <p style="color: #999; text-align: center;">No services added yet</p>
                    </div>
                </div>

                <div class="total-section">
                    <h3>Total Amount:</h3>
                    <div class="total-amount">Rs. <span id="total-amount">0.00</span></div>
                </div>

                <div class="action-buttons">
                    <button class="button save-button" id="saveInvoiceBtn">üíæ Save Invoice</button>
                    <button class="button whatsapp-button" id="whatsappBtn">üì± Send to WhatsApp</button>
                    <button class="button copy-button" id="copyBtn">üìã Copy Message</button>
                </div>
                <div id="create-notification" class="notification"></div>
            </div>
        </div>

        <div id="list-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card total">
                    <h3>Total Invoices</h3>
                    <div class="stat-value" id="totalInvoices">0</div>
                </div>
                <div class="stat-card paid">
                    <h3>Paid</h3>
                    <div class="stat-value" id="paidCount">0</div>
                    <p style="font-size: 14px; color: #666; margin-top: 5px;">Rs. <span id="paidAmount">0</span></p>
                </div>
                <div class="stat-card unpaid">
                    <h3>Not Paid</h3>
                    <div class="stat-value" id="unpaidCount">0</div>
                    <p style="font-size: 14px; color: #666; margin-top: 5px;">Rs. <span id="unpaidAmount">0</span></p>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <input type="text" id="searchCustomer" class="filter-input" placeholder="üîç Search by customer name...">
                    <select id="filterStatus" class="filter-input">
                        <option value="all">All Status</option>
                        <option value="paid">Paid</option>
                        <option value="not paid">Not Paid</option>
                    </select>
                    <button class="button" style="background-color: #4a69bd;" id="refreshBtn">üîÑ Refresh</button>
                </div>
            </div>

            <div class="invoice-table">
                <div id="invoiceList"></div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://uqgzlaxsnknheoerbfus.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxZ3psYXhzbmtuaGVvZXJiZnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MjM2MTUsImV4cCI6MjA3OTI4MzYxNX0.IYWZ7ukx8J-GJMWy7cMk2BWnmzJmJjjE93yEmJie7nQ';

        let selectedServices = [];
        let total = 0;
        let allInvoices = [];

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            document.getElementById('usdRate').addEventListener('input', updateAllPrices);
            document.getElementById('priceType').addEventListener('change', togglePriceInput);
            document.getElementById('addServiceBtn').addEventListener('click', addService);
            
            document.getElementById('serviceName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addService();
            });
            document.getElementById('servicePrice').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addService();
            });
            
            document.getElementById('saveInvoiceBtn').addEventListener('click', saveInvoice);
            document.getElementById('whatsappBtn').addEventListener('click', shareToWhatsApp);
            document.getElementById('copyBtn').addEventListener('click', copyMessage);
            
            document.getElementById('searchCustomer').addEventListener('input', filterInvoices);
            document.getElementById('filterStatus').addEventListener('change', filterInvoices);
            document.getElementById('refreshBtn').addEventListener('click', loadInvoices);
            
            fetchUSDRate();
            loadInvoices();
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            if (tab === 'create') {
                document.getElementById('create-tab').classList.add('active');
                document.querySelector('[data-tab="create"]').classList.add('active');
            } else {
                document.getElementById('list-tab').classList.add('active');
                document.querySelector('[data-tab="list"]').classList.add('active');
                loadInvoices();
            }
        }

        async function fetchUSDRate() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                if (data.rates && data.rates.LKR) {
                    document.getElementById('usdRate').value = Math.round(data.rates.LKR);
                    updateAllPrices();
                }
            } catch (error) {
                console.log('Using manual rate');
            }
        }

        function togglePriceInput() {
            const priceType = document.getElementById('priceType').value;
            const priceInput = document.getElementById('servicePrice');
            priceInput.placeholder = priceType === 'usd' ? 'USD Amount' : 'LKR Amount';
        }

        function calculatePrice(usdAmount) {
            const usdRate = parseFloat(document.getElementById('usdRate').value);
            return (usdRate + 180) * usdAmount;
        }

        function addService() {
            const serviceName = document.getElementById('serviceName').value.trim();
            const priceType = document.getElementById('priceType').value;
            const amount = parseFloat(document.getElementById('servicePrice').value);

            if (!serviceName || !amount || amount <= 0) {
                showNotification('create-notification', 'Please enter valid service name and amount', 'error');
                return;
            }

            let finalPrice, displayText;
            if (priceType === 'usd') {
                finalPrice = calculatePrice(amount);
                displayText = `${serviceName} (${amount} USD)`;
            } else {
                finalPrice = amount;
                displayText = serviceName;
            }

            selectedServices.push({
                name: displayText,
                price: finalPrice,
                usdAmount: priceType === 'usd' ? amount : null,
                id: Date.now()
            });

            total += finalPrice;
            updateDisplay();

            document.getElementById('serviceName').value = '';
            document.getElementById('servicePrice').value = '';
            document.getElementById('serviceName').focus();
            
            showNotification('create-notification', '‚úÖ Service added!', 'success');
        }

        function removeService(id) {
            const serviceIndex = selectedServices.findIndex(service => service.id === id);
            if (serviceIndex !== -1) {
                total -= selectedServices[serviceIndex].price;
                selectedServices.splice(serviceIndex, 1);
                updateDisplay();
                showNotification('create-notification', 'Service removed', 'success');
            }
        }

        function updateAllPrices() {
            total = 0;
            selectedServices.forEach(service => {
                if (service.usdAmount) {
                    service.price = calculatePrice(service.usdAmount);
                }
                total += service.price;
            });
            updateDisplay();
        }

        function updateDisplay() {
            const selectedItems = document.getElementById('selected-items');
            const totalAmount = document.getElementById('total-amount');
            
            if (selectedServices.length === 0) {
                selectedItems.innerHTML = '<p style="color: #999; text-align: center;">No services added yet</p>';
            } else {
                const servicesHTML = selectedServices.map(service => `
                    <div class="service-row">
                        <div>
                            <strong>${service.name}</strong><br>
                            <span style="color: #666; font-size: 14px;">Rs. ${service.price.toFixed(2)}</span>
                        </div>
                        <button class="remove-btn" onclick="removeService(${service.id})">Remove</button>
                    </div>
                `).join('');
                
                selectedItems.innerHTML = servicesHTML;
            }
            
            totalAmount.textContent = total.toFixed(2);
        }

        function generateMessage() {
            const customerName = document.getElementById('customerName').value.trim();
            
            if (!customerName) {
                document.getElementById('customerError').textContent = 'Customer name is required!';
                return null;
            }
            document.getElementById('customerError').textContent = '';

            if (selectedServices.length === 0) {
                showNotification('create-notification', 'Please add at least one service!', 'error');
                return null;
            }

            let message = '';
            message += '================================\n';
            message += '    DIGITAL SERVICES INVOICE\n';
            message += '================================\n\n';
            message += `Customer Name: ${customerName}\n\n`;
            message += '--------------------------------\n';
            message += 'SERVICES AND CHARGES\n';
            message += '--------------------------------\n\n';
            
            selectedServices.forEach((service, index) => {
                message += `${index + 1}. ${service.name}\n`;
                message += `   Rs. ${service.price.toFixed(2)}\n\n`;
            });
            
            message += '--------------------------------\n';
            message += `TOTAL AMOUNT: Rs. ${total.toFixed(2)}\n`;
            message += '================================\n\n';
            message += 'BANK DETAILS\n';
            message += '--------------------------------\n\n';
            message += 'PEOPLES BANK\nMathugama\n070-2-001-6-23-28-309\nUKDA KOSALA\n\n';
            message += 'Bank of Ceylon\nKalutara\n89-32-36-00\nRG Lakmini\n\n';
            message += '--------------------------------\n';
            message += 'IMPORTANT NOTES\n';
            message += '--------------------------------\n\n';
            message += '- Online Transfer: Forward bank SMS confirmation or PDF receipt\n';
            message += '- Cash Deposit: Send clear photo of deposit slip\n\n';
            message += '--------------------------------\n';
            message += 'CONTACT INFORMATION\n';
            message += '--------------------------------\n\n';
            message += 'WhatsApp: +94 716637804\nPhone: 0701551279\nEmail: urc.eduhelp@gmail.com\n\n';
            message += '================================\n';
            message += 'Thank you for your business!\nEDU AD\n';
            message += '================================';
            
            return message;
        }

        function shareToWhatsApp() {
            const message = generateMessage();
            if (message) {
                window.open(`https://wa.me/?text=${encodeURIComponent(message)}`);
            }
        }

        function copyMessage() {
            const message = generateMessage();
            if (message) {
                navigator.clipboard.writeText(message).then(() => {
                    showNotification('create-notification', 'Message copied successfully!', 'success');
                });
            }
        }

        function quickCreateFromInvoice(customerName, price) {
            switchTab('create');
            document.getElementById('customerName').value = customerName;
            
            selectedServices = [];
            total = 0;
            
            selectedServices.push({
                name: 'Previous Invoice Amount',
                price: parseFloat(price),
                usdAmount: null,
                id: Date.now()
            });
            
            total = parseFloat(price);
            updateDisplay();
            
            showNotification('create-notification', `‚úÖ Invoice template created for ${customerName}!`, 'success');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function saveInvoice() {
            const customerName = document.getElementById('customerName').value.trim();
            
            if (!customerName) {
                document.getElementById('customerError').textContent = 'Customer name is required!';
                return;
            }
            
            if (selectedServices.length === 0) {
                showNotification('create-notification', 'Please add at least one service!', 'error');
                return;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/my_invoice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        customer: customerName,
                        price: parseFloat(total.toFixed(2)),
                        paid_not_paid: 'not paid'
                    })
                });

                if (response.ok) {
                    showNotification('create-notification', '‚úÖ Invoice saved successfully!', 'success');
                    
                    setTimeout(() => {
                        selectedServices = [];
                        total = 0;
                        document.getElementById('customerName').value = '';
                        updateDisplay();
                    }, 2000);
                } else {
                    showNotification('create-notification', '‚ùå Error saving invoice', 'error');
                }
            } catch (error) {
                showNotification('create-notification', '‚ùå Error: ' + error.message, 'error');
            }
        }

        async function loadInvoices() {
            const listDiv = document.getElementById('invoiceList');
            listDiv.innerHTML = '<div class="loading">Loading invoices...</div>';

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/my_invoice?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    allInvoices = await response.json();
                    displayInvoices(allInvoices);
                    updateStats(allInvoices);
                } else {
                    listDiv.innerHTML = '<div class="empty-state">‚ùå Error loading invoices</div>';
                }
            } catch (error) {
                listDiv.innerHTML = '<div class="empty-state">‚ùå Error: ' + error.message + '</div>';
            }
        }

        function displayInvoices(invoices) {
            const listDiv = document.getElementById('invoiceList');
            
            if (invoices.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">üì≠ No invoices found</div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoices.map(invoice => `
                            <tr>
                                <td>${invoice.id}</td>
                                <td><strong>${invoice.customer}</strong></td>
                                <td>Rs. ${parseFloat(invoice.price).toFixed(2)}</td>
                                <td>
                                    <span class="status-badge ${invoice.paid_not_paid === 'paid' ? 'paid' : 'not-paid'}">
                                        ${invoice.paid_not_paid === 'paid' ? '‚úÖ Paid' : '‚è≥ Not Paid'}
                                    </span>
                                </td>
                                <td>${new Date(invoice.created_at).toLocaleDateString('si-LK')}</td>
                                <td>
                                    <button class="action-btn quick-create-btn" onclick="quickCreateFromInvoice('${invoice.customer.replace(/'/g, "\\'")}', ${invoice.price})">
                                        üîÑ Quick Create
                                    </button>
                                    <button class="action-btn update-btn" onclick="updatePaymentStatus(${invoice.id}, '${invoice.paid_not_paid}')">
                                        ${invoice.paid_not_paid === 'paid' ? 'Mark Unpaid' : 'Mark Paid'}
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteInvoice(${invoice.id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            listDiv.innerHTML = tableHTML;
        }

        function updateStats(invoices) {
            const paidInvoices = invoices.filter(i => i.paid_not_paid === 'paid');
            const unpaidInvoices = invoices.filter(i => i.paid_not_paid === 'not paid');
            
            const paidTotal = paidInvoices.reduce((sum, i) => sum + parseFloat(i.price), 0);
            const unpaidTotal = unpaidInvoices.reduce((sum, i) => sum + parseFloat(i.price), 0);
            
            document.getElementById('totalInvoices').textContent = invoices.length;
            document.getElementById('paidCount').textContent = paidInvoices.length;
            document.getElementById('unpaidCount').textContent = unpaidInvoices.length;
            document.getElementById('paidAmount').textContent = paidTotal.toFixed(2);
            document.getElementById('unpaidAmount').textContent = unpaidTotal.toFixed(2);
        }

        function filterInvoices() {
            const searchTerm = document.getElementById('searchCustomer').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            
            let filtered = allInvoices;
            
            if (searchTerm) {
                filtered = filtered.filter(invoice => 
                    invoice.customer.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter !== 'all') {
                filtered = filtered.filter(invoice => 
                    invoice.paid_not_paid === statusFilter
                );
            }
            
            displayInvoices(filtered);
        }

        async function updatePaymentStatus(id, currentStatus) {
            const newStatus = currentStatus === 'paid' ? 'not paid' : 'paid';
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/my_invoice?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        paid_not_paid: newStatus
                    })
                });

                if (response.ok) {
                    loadInvoices();
                } else {
                    alert('Error updating payment status');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteInvoice(id) {
            if (!confirm('Are you sure you want to delete this invoice?')) {
                return;
            }
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/my_invoice?id=eq.${id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    loadInvoices();
                } else {
                    alert('Error deleting invoice');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showNotification(elementId, message, type) {
            const notification = document.getElementById(elementId);
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
